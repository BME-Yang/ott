function [gy,fx,fxc,fz,gz,net_output,net_input] = WEES(D,lam)
%WEES evaluates the dimensionless wall effects of eccentric spheres using 
%an artificial neural network as well as analytical limiting results.
%   The function takes two inputs which can be matrices of equal sizes or, 
%   one matrix and one scalar. D represents d/a which is the minimum 
%   clearance distance in units of the inner spherical radius. 
%   lam represents a/b which is the ratio of the spherical boundaries.
%
%   gy, fx, fxc, fz and gz are the dimensionless asymmetric rotational, 
%   asymmetric translational, rotation-translation coupling, axisymmetric
%   translational and axisymmetric rotational wall effects respectively.
%   net_output and net_input are matrices corresponding to the neural
%   network's inputs and outputs.
%
%   This file is supplementary matrial to Gibson, et al. (2018)


%% Input processing
% Establish the dimensionality of the outputs from the inputs
if numel(D)>1
    dims=size(D);
else
    dims=size(lam);
end

% Vectorise any scalar inputs
D=D(:); lam=lam(:);
if length(D)==1
    D=repmat(D,[length(lam),1]);
elseif length(lam)==1
    lam=repmat(lam,[length(D),1]);
end

net_input=[(D-1)./(D+1),2*lam-1]';

%% Neural Network
% Biases and weights
B1=[4.81133939170864533;4.5643461158080027573;-4.5063285833168071903;5.2115319979339691514;2.6380770861922484549;12.991962857468127623;10.440263371228514444;-1.96619386337468538;1.6562524790560868571;1.5871350838826545626;-18.154178032015220623;-101.11570376205743571;0.13941239526906393231;-0.34850942372046794793;4.1411886346892705646;-0.07917596408181269696;0.11709930844202189049;3.170105490295324735;-12.493281101349390738;0.13945188069421549093;-5.5099320042082329252;0.24073580170324179739;1.6609391644052773351;-1.8788658821717361125;-0.38260521521963841707;-4.283353475659754217;-3.3792586129868431577;6.7632511548622398223;-3.3592868838747929061;0.35806923733237089325;-2.5564898272305138782;2.4520402287222382576;20.383505083237938749;0.16392206380688176259;20.773333686527038822;-7.1753130375557034881;20.862432735936440764;7.0845249333817728044;-64.328545667313647982;6.4134444128602847712;65.937009998976051861;40.204736422019230702;20.600209283073329658;-20.482694555287594085;123.37740008888198417;-1.932947948463519694;-120.01856639574019425;65.216126933375548447;195.54733776608389917;7.183756611465129005];
W1=[-2.9231488399282312685 -0.19127824688034011924;-10.860592103533855735 -9.897654383383068577;2.5794290929996850359 -0.57787838817321623974;-0.89619241594655552063 3.3242802093036702971;-3.3084402439788593853 -4.3683344730888853391;-11.787910712063585095 -24.278600164950322693;-21.973296276076982991 -30.476054243098719354;-0.93824276711271481499 -0.74110630896917051302;-0.5080929990885226788 1.0002596105380063829;-0.59273394368022003231 0.84789890222052355373;-5.521469714338704371 10.740686541516470953;-87.529198833577055439 12.362802540974248799;-1.4397034037591445177 0.18357731809708374704;-0.62701716900893023077 -0.58818834276227249802;-10.308195460067361537 -9.157660932756586547;1.2190826795480869116 0.083425230823917395639;0.4657172590565397674 -0.34610800833871357973;-0.23574606596510533363 -3.4757204791671836297;13.457111323925216695 24.860202359214611079;-1.5153368573808834174 0.13135781028470377985;5.1259728730717117884 9.4554294158012837102;-1.2733534296408191011 -0.05898009645303457088;0.36350977972561276941 -1.3092586193836976971;-1.929091247138254861 0.41248142560622702568;-0.14451115484298215907 0.18892010976331233274;9.6026274840032943558 11.29706706425329088;-2.4819184382279888545 0.48181725586740126177;-2.9390104697362500197 -8.3092822101300498616;-2.0614462538000557501 0.37425450457535364146;-1.7091651174730932983 -1.1349918842585187129;-1.4286332447999909867 1.3590837228532306469;-2.4781978625096838798 -2.8018789771626670948;19.792641099231232715 0.51851369776998756933;0.057365109867923903819 -0.49034398100573739487;20.332416321103597312 0.30276654353634729899;-6.8201545876319542572 -0.62906033438129072;19.184504910889412344 -1.5202990838998919898;4.7165265597087993044 0.43219732403052846248;-63.52382760810309037 0.7874110310798864143;1.826704939977480624 -2.8176156000664454027;65.223835388787804845 -0.90004385687304000463;34.813309182574762701 -5.4050049419608958701;20.081595533999692549 0.41455639142510219974;-18.71727561979725607 1.6166552265998306304;122.0767705701791499 -1.5272900291585984611;-0.95373000006523223071 -0.70341812999374830895;-118.69376120300437094 1.4582814912174784094;63.648382804621242315 -0.7509766071961153644;191.51907724168410141 -2.1452241234187225949;6.8299257538385891309 0.63479724961522920879];
B2=[-5.695527728718502658;-19.715168261303599451;25.929231046879912981;40.363108365097964736;-3.5442270771277586405];
W2=[-6.3213833502016125721 -19.759476500265389376 -1.6816723467881136145 -0.12901483762518783927 -4.8869386832023637979 14.790883202536463159 14.074860397446679272 1.8272341487535459503 -2.7220653396917922073 3.6306309655730348851 0.40812944942644363566 -3.5990025090235278071 -0.79059739036971232728 -0.95215952526399472156 7.1192099143925755556 4.9993719967778824653 -4.5114091862517451403 0.73913844397591721425 45.880420315656721186 1.3255305169232838303 12.578024791672179461 3.9380972434148322492 1.1210299505009568843 0.69266208569933607198 -9.187108053769406979 -2.5293360531108532996 9.3875976091930244394 29.295548878308732554 -26.594557773449402305 -0.12406359673585358461 -0.21646258650516259081 0.59375221856533588749 3.8065897999891076253 2.4749204160883153669 3.3112701342191015463 2.0843823786372319695 -3.1956922377628180776 -4.2952772680752859813 -15.494941359418323401 4.9135100230063457616 -3.63970981259033044 0.29920049252749059132 -7.0566526876680129021 -3.3415423227592686573 -9.368520644242614992 -2.395377487498375757 -14.384762702078372598 -52.0918214853494419 33.022971410935419101 2.1302686151971998996;-18.123169312996935787 -10.955626803875397002 -5.2511235083790701594 -0.58020696670181348686 0.68458722736435795309 -4.810931998097291995 -6.5362531629502100827 -15.152261514730341219 -2.7714041741609594105 3.2871044337501138521 -17.993253340339983026 -2.8369500274619241509 -1.1726015536352287771 0.66840542032389393956 3.3686356543097391025 4.0872405723571185732 0.29811614482053466757 -0.39776157787431654089 -14.284513413627845324 1.3980773523496026201 -2.4511914416320341736 3.7897635344711684269 -0.63803385017440061855 0.30858375549791289272 -7.8246746328474729992 2.0056762946654713708 6.5688574602669076441 -8.6337375458672376283 -19.567720308115575278 -0.10956647206971170672 -0.49888707155264910842 -1.2854600098341724124 3.8804100552655906853 -2.8603028001816879211 3.3967786239730322073 -5.2005432379533713672 -2.4801920363304135186 -7.5974342259508969022 -12.659212445585996676 20.662964006605736955 -2.9529805487795282026 0.21557488325739818102 -7.2266400598422873003 -2.5743200188424149033 -7.466564113855481466 16.12179292964339794 -11.541027831961713446 -42.607981760445852615 27.524029720563937929 -5.0604976719121905759;-12.35548307701747639 -15.427646180140294874 -3.2960726424533741685 -0.33093262986495813882 -0.082493242898283442033 -0.11552022268791756199 -0.20613600306186666278 -4.4719600835641974967 -2.9031277036576366157 2.5964378140839325937 0.042159326468258463694 0.050704841823288708536 1.6829039989567113889 -1.8153525793185427695 6.468320886391647484 0.94409221483588146029 3.1590264727353405405 0.022167735342896770917 -0.35900890127781609484 -1.191480603113270087 -0.18342766567286813983 0.66840071862422423266 0.36837788915911950927 -0.11972862449708646104 24.299861802366859109 0.15567843512823625884 -0.041558871749888447178 -0.26950606099834428786 -0.72779693433196601671 -0.14858281484932772676 0.01472824368319923527 0.93238020921598074864 0.083159282594774355801 8.9343512472240433908 0.12425489909808350164 -2.7183035505695678502 0.010624945059372600809 -2.0037383553531977753 -0.83664249624250919268 -0.37330178337580555148 -0.18886983902305595762 -0.0010200251074920540281 -0.20823667213190008574 0.01581320804899912294 -0.63593297089534017719 4.4646889694679412486 -0.93543662514970182809 -2.8920707280820181495 1.5653953711718853192 -2.6742399406256707195;32.938574343900263841 19.596162775689517588 8.1682192182209423237 0.41179354360527348211 -1.8959001244695590227 4.1409807949015977613 -0.5987574772825647873 16.482887321824271964 10.90628245490112036 -13.685592463179837353 9.220253769954409151 4.1705860831914414177 -5.5206363179491546589 4.9081699297542256133 -15.307481516399599641 -2.6496286964090307592 12.937801356275043574 0.28666820562607875367 12.601054145851746213 3.7415378749655787693 4.6062156881307618761 -0.51027143309263867099 1.1595935905292873436 -1.0364245294006397824 16.922558126989098781 4.5601493879474652715 -12.566227082319912256 9.5683882317282211716 34.762897191064816127 0.4190172503833378137 0.55719107039134130321 -6.4809260311247065545 -5.8080313292275942416 -11.453806725275791578 -5.1968767852536883467 -1.2745542116103574237 3.7007527069384726914 3.157367564418956718 19.738608952202127966 -10.477383951882714541 4.5887706249284949678 -0.32442703345219592315 10.978268622151167833 3.8363282589590532723 11.553057096863257769 -14.534989435562112092 17.901586262809363603 66.532393156060365413 -43.147710180460784102 -1.2721418387745939693;-1.9663136042452136198 -6.8921280486718474734 -0.56582731372846761797 -0.065380236277280595614 -0.79845435467079184377 1.0302538739127016232 0.80570815792976047121 11.625041883113313546 -0.87789713354158427361 1.0218652284278604281 -7.36561189675857797 2.2782291261854052955 0.11718536503438406471 -0.63673305209854946796 2.4936586913966611867 0.22328976951986018173 -1.390495168581866503 0.035013077313501048127 3.5595015588412994845 -0.091354022771236095823 1.7129770466087557157 0.077155284960230219315 0.29330014071044802071 -0.35768970183032511301 3.0753937452217132709 -0.42652554402400866262 -5.9786109178560398192 2.9499412640713766898 18.847575013877552408 -0.091429445078719820406 -0.10686906020360653624 -1.2092875240722760211 -4.6632912811230760042 3.3752432440032298366 -3.9310156707590726555 1.1503635261448859062 2.4594603430155888013 8.790761774682067653 13.672629486862984294 9.3274769982304803762 3.2074760243585336283 -0.1797619863018027897 8.5102877104501679639 2.5204329572524946101 8.1066735344664113683 -12.312115509099610833 12.503635267829968925 45.908740680982404569 -29.453425102514763978 1.0067910592000837156];

% Number of samples
n=size(net_input,2);

% Hidden layer sigmoidal activation function
sigma=@(x) 2./(1+exp(-2*x))-1;

% Evaluate network outputs
net_output=repmat(B2,1,n)+W2*sigma(repmat(B1,1,n)+W1*net_input);

%% Scale network outputs and add singular terms
% d/a->0 singular terms, where L=a/b and 0<=L<1
fzlim=@(L,d) ((1-L).^2.*d).^-1-1/5*(1-7*L+L.^2)./(1-L).^3.*log(d);
gzlim=@(L,d) zeros(size(d));
fxclim=@(L,d) 2/15*(1-4*L)./(1-L).^2.*log(d);
fxlim=@(L,d) -4/15*(2-L+2*L.^2)./(1-L).^3.*log(d);
gylim=@(L,d) -2/5*1./(1-L).*log(d);

% concentric limit (d/a->1/L-1), where L=a/b and 0<=L<1
fcon=@(L) 4*(1-L.^5)./((1-L).^4.*(4+7*L+4*L.^2));
gcon=@(L) 1./(1-L.^3);

% Reshape outputs to match the input dimensionality
gy =reshape(net_output(1,:)'.*gcon(lam)+ gylim(lam,D)./(1+D.^2),dims);
fx =reshape(net_output(2,:)'.*fcon(lam)+ fxlim(lam,D)./(1+D.^2),dims);
fxc=reshape(net_output(3,:)'.*fcon(lam)+fxclim(lam,D)./(1+D.^2),dims);
fz =reshape(net_output(4,:)'.*fcon(lam)+ fzlim(lam,D)./(1+D.^2),dims);
gz =reshape(net_output(5,:)'.*gcon(lam)+ gzlim(lam,D)./(1+D.^2),dims);

end


